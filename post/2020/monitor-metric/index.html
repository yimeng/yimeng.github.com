<!doctype html><html lang=zh-cn><title>监控最佳实践-指标篇 | 出租窝</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.125.3"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://git.yimeng.ch/post/2020/monitor-metric/><link rel=alternate type=application/rss+xml href title=出租窝><link rel=stylesheet href=https://git.yimeng.ch/css/theme.css><link rel=stylesheet href=https://git.yimeng.ch/css/classes.css><header class=dark><h2><a href=https://git.yimeng.ch/>出租窝</a></h2><nav></nav></header><article><header><h1><a href=https://git.yimeng.ch/post/2020/monitor-metric/>监控最佳实践-指标篇</a></h1><p class=meta><time datetime=2020-10-18T12:43:49+08:00>October 18, 2020</time></p></header><h1 id=监控最佳实践-指标篇>监控最佳实践-指标篇</h1><h2 id=监控指标分类体系>监控指标分类体系</h2><p>监控指标体系目前有三种主要的分类方式：</p><ul><li><p>​ <a href=http://www.brendangregg.com/usemethod.html>USE Method</a> (from Brendan Gregg): <strong>Utilization, Saturation, and Errors</strong></p></li><li><p>​ <a href=https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/>RED Method</a> (from Tom Wilkie): <strong>Rate, Errors, and Duration</strong></p></li><li><p>​ <a href="https://smile.amazon.com/Site-Reliability-Engineering-Production-Systems/dp/149192912X/ref=sr_1_1">Google SRE book</a>: <strong>Latency, Traffic, Errors, and Saturation</strong></p></li></ul><h3 id=use方法>USE方法</h3><ul><li>利用率（Utilization）：资源繁忙的时间百分比，例如节点CPU使用率。</li><li>饱和度（Saturation）：资源必须完成的工作量，通常是队列长度或节点负载。</li><li>错误（Errors）：错误事件计数。</li></ul><p>主要适用场景：</p><p>基础结构中的硬件资源，例如CPU，内存和网络设备。</p><h3 id=red方法>RED方法</h3><ul><li>速率：每秒请求，每天访问人数等。</li><li>错误：失败的请求数，</li><li>持续时间：这些请求花费的时间，延迟测量的分布</li></ul><p>主要适用场景：</p><p>这种方法比较适用于服务级别，尤其是微服务。对于研发提供的服务，建议每个组件的服务都暴露一些这样的指标。因为RED 的方法比较适合做成看板和统计SLO。在grafana最佳实践中：建议一个服务做成一行，横向放置某一接口的速率和错误和持续时间。</p><p><img src=https://www.weave.works/docs/cloud/latest/images/monitoring/red-method-dashboard.png alt></p><h3 id=sre黄金指标>SRE黄金指标</h3><p>此方法与RED方法相似，但包含饱和度。</p><ul><li>延迟（Latency）：处理请求所需的时间</li><li>流量（Traffic）：系统上有多少请求</li><li>错误（Errors）：失败请求率</li><li>饱和度（Saturation）：系统有多“满”，例如负载和队列积压。</li></ul><p>主要适用场景：</p><p>属于较为通用的场景（合集），基本上是个筐，什么都可以往里装。</p><p>这里可以说一下Latency里面有一个重要的概念就是Apdex（Application Performance Index）这是一个从APM角度评价性能的标准，主要用于评价用户体验的。比如打开一个服务用的总延迟是多少，根据这个延迟进行一个评分，最后落到0-1之间。</p><h2 id=指标分类对比>指标分类对比</h2><p>方法没有好坏之分，比如比较以下从USE和SRE的两个角度来对于基础设施监控的维度，其实都是可以的，只要适合自己的系统情况即可。</p><p>USE方法是我自己从经验角度来进行的归类。</p><p>SRE方法是来自https://www.jianshu.com/p/b01bc69fcc3b 的内容。</p><p>但更推荐看https://medium.com/@steve.mushero/linuxs-sre-golden-signals-af5aaa26ebae 里关于系统监控项的内容。</p><h3 id=use方法-1>USE方法</h3><h4 id=cpu>CPU</h4><ul><li>利用率（Utilization）：CPU使用率。</li><li>饱和度（Saturation）：CPU负载。</li><li>错误（Errors）：CPU错误</li></ul><h4 id=内存>内存</h4><ul><li>利用率（Utilization）：内存使用率。</li><li>饱和度（Saturation）：内存换入换出。</li><li>错误（Errors）：内存错误 OOM</li></ul><h4 id=磁盘>磁盘</h4><ul><li>利用率（Utilization）：磁盘使用率 inode使用率。</li><li>饱和度（Saturation）：IO读写流量。</li><li>错误（Errors）：IO</li></ul><h4 id=网络>网络</h4><ul><li>利用率（Utilization）：流量 收发包数 。</li><li>饱和度（Saturation）：网卡带宽使用率。</li><li>错误（Errors）：网络设备错误，丢包</li></ul><h4 id=tcp>TCP</h4><ul><li>利用率（Utilization）：单个TCP收发包大小？。</li><li>饱和度（Saturation）：TCP状态连接数。</li><li>错误（Errors）：中断？</li></ul><h3 id=sre黄金指标-1>SRE黄金指标</h3><ul><li><p>要测量CPU，以下测量可能是合适的：</p><ul><li>延迟：CPU调度程序的平均或最大延迟</li><li>流量：CPU利用率</li><li>错误：处理器特定的错误事件，出现故障的CPU</li><li>饱和度：运行队列长度</li></ul><p>对于内存，信号可能有如下所示：</p><ul><li>延迟 :(没有 - 很难找到一个好的测量方法而且不可操作）</li><li>流量：正在使用的内存量</li><li>错误：内存不足错误</li><li>饱和度：OOM杀手事件，交换使用</li></ul><p>对于存储设备：</p><ul><li>延迟：读取和写入的平均等待时间（await）</li><li>流量：读写I / O级别</li><li>错误：文件系统错误，磁盘错误 /sys/devices</li><li>饱和度：I / O队列深度</li></ul><p>该网络信号可以是这样的：</p><ul><li>延迟：网络驱动程序队列</li><li>流量：每秒传入和传出的字节或数据包</li><li>错误：网络设备错误，丢包</li><li>饱和度：溢出，丢弃数据包，重新传输的段</li></ul><p>对于为客户提供服务的应用程序，四个黄金信号通常可以很容易地选择：</p><ul><li>延迟：完成请求的时间</li><li>流量：每秒服务请求数</li><li>错误：处理客户端请求或访问资源时发生的应用程序错误</li><li>饱和度：当前使用的资源的百分比或数量</li></ul></li></ul><h2 id=后续>后续</h2><p>后面会针对grafana，使用对于监控指标的可视化方面做个大致的介绍。大致内容有</p><ul><li>Grafana as Code</li><li>Gitlab grafana最佳实践</li></ul><h2 id=参考文档>参考文档</h2><blockquote><p><a href="https://www.youtube.com/watch?v=pOo0oKNM9I8">https://www.youtube.com/watch?v=pOo0oKNM9I8</a></p><p><a href=https://medium.com/faun/how-to-monitor-the-sre-golden-signals-1391cadc7524>https://medium.com/faun/how-to-monitor-the-sre-golden-signals-1391cadc7524</a></p><p><a href=https://mint.splunk.com/static/images/landing/splunk/network.png>https://mint.splunk.com/static/images/landing/splunk/network.png</a></p><p><a href=https://grafana.github.io/grafonnet-lib/>https://grafana.github.io/grafonnet-lib/</a></p><p><a href=https://xie.infoq.cn/article/be5d880666c29c66b7eff65dc>https://xie.infoq.cn/article/be5d880666c29c66b7eff65dc</a></p><p><a href=https://github.com/weaveworks/grafanalib>https://github.com/weaveworks/grafanalib</a></p><p><a href=https://github.com/K-Phoen/grabana>https://github.com/K-Phoen/grabana</a></p><p><a href=https://sdgmf.github.io/goproject/>https://sdgmf.github.io/goproject/</a></p></blockquote></article></html>