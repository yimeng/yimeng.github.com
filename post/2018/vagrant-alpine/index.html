<!doctype html><html lang=zh-cn><title>Vagrant Alpine | 出租窝</title>
<meta charset=utf-8><meta name=generator content="Hugo 0.125.3"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=canonical href=https://git.yimeng.ch/post/2018/vagrant-alpine/><link rel=alternate type=application/rss+xml href title=出租窝><link rel=stylesheet href=https://git.yimeng.ch/css/theme.css><link rel=stylesheet href=https://git.yimeng.ch/css/classes.css><header class=dark><h2><a href=https://git.yimeng.ch/>出租窝</a></h2><nav></nav></header><article><header><h1><a href=https://git.yimeng.ch/post/2018/vagrant-alpine/>Vagrant Alpine</a></h1><p class=meta><time datetime=2018-02-09T13:40:05+08:00>February 09, 2018</time></p></header><h1 id=vagrant-alpine自定义实战>vagrant-alpine自定义实战</h1><h2 id=背景>背景</h2><p>在docker CI CD devops各种新鲜事务的潮流下，<a href=http://cloudscaling.com/blog/cloud-computing/the-history-of-pets-vs-cattle/>Pets=>Cattle</a> 也告诉运维要的一个思维的转变。
这个就需要很多的牛来做实验.</p><p>13年在做puppet的CI/CD的时候，单位有一个OpenStack环境，利用api还是很爽的。后来嫌弃创建实例太慢，又开始用了docker。但docker还是有一定的局限性，比如dns和一些系统参数无法修改验证。vagrant也不错，但当时没有一个精简合适的Linux发行版，启动和资源占用还是很耗费电脑的。</p><p>在玩docker的时候，发现了alpine这个系统。几十兆到一百兆，经过优化之后启动大概10s就ok。虽然官方有做好了的vagrant镜像。但是感觉还是不够本地化。就有了自己搞的念头。</p><h2 id=安装alpine>安装alpine</h2><p><a href=https://alpinelinux.org/downloads/>alpine下载</a>
如果是virtualbox，选择VIRTUAL版本即可。</p><p>下载回来是一个iso文件，用virtualbox加载引导。用户名root 密码为空。登陆之后运行setup-alpine开始安装。具体内容这里就不说了。可以看<a href=http://blog.csdn.net/csdn_duomaomao/article/details/76053229>这里</a></p><h2 id=vagrant配置>vagrant配置</h2><ol><li>添加vagrant账户，密码好像无所谓，最好也是vagrant</li><li><a href=https://github.com/hashicorp/vagrant/tree/master/keys>vagrant的公钥</a>放到~/.ssh/下面，注意好.ssh和公钥的权限问题</li><li>sudo里加上vagrant</li><li>root密码为vagrant</li><li>网络访问方式需要是NAT，这个在打包的时候vagrant甚至还会检测是否把端口映射关闭掉。</li><li>ssh加速需要把sshd里的UseDNS禁止掉，否则可能ssh进去的时候会稍微慢一点</li></ol><p>以上是官方的建议，下面来点我自己的干货</p><h3 id=sshd相关配置>sshd相关配置</h3><p>sshd里把最大尝试次数设置的多一点,因为在启动的时候vagrant会进行几次尝试，这时候如果出现一些意外的小状况的话，会被sshd直接拒绝，实验环境，密码私钥都是公开的了，也无所谓尝试几次了。</p><h3 id=启动倒计时>启动倒计时</h3><p>启动的时候有3秒的倒计时，如果介意2秒的启动速度的话可以编辑 /etc/update-extlinux.conf文件，设置timeout=1，然后执行update-extlinux，重启即可看到效果</p><h3 id=chrony启动优化>chrony启动优化</h3><p>启动的时候chrony会有一些慢，可能是在算本地时钟是否准确。如果介意的话可以编辑/etc/chrony/chrony.conf文件，把initstepslew那行注释掉即可提高启动速度，并且把各种ntp的源找个国内的填上比如 cn.pool.ntp.org</p><h3 id=repo源优化>repo源优化</h3><p>改成国内的源，并且用@ pin住，如果加了testing等源的话，会提示apk-tools版本太老，可以用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apk add --upgrade apk-tools@edge
</span></span></code></pre></div><p>进行升级</p><p>/etc/apk/repositories</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>https://mirrors.ustc.edu.cn/alpine/latest-stable/main
</span></span><span style=display:flex><span>https://mirrors.ustc.edu.cn/alpine/latest-stable/community
</span></span><span style=display:flex><span>@edge https://mirrors.ustc.edu.cn/alpine/edge/main
</span></span><span style=display:flex><span>@edgecommunity https://mirrors.ustc.edu.cn/alpine/edge/community
</span></span><span style=display:flex><span>@testing https://mirrors.ustc.edu.cn/alpine/edge/testing
</span></span></code></pre></div><h2 id=最后>最后</h2><p>找个目录执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>vagrant package --base vagrant-alpine --output vagrant-alpine.box
</span></span></code></pre></div><p>&ndash;base后面是virtualbox的名称，生成为vagrant-alpine.box。
但别着急编辑vagrantfile，还需要用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant box list
</span></span></code></pre></div><p>看一下，否则up执行的可能是已经add过的老box，而不是这个新的。这点尤其要注意，我就被坑了2个多小时。</p><p>调试完毕之后，就可以去https://app.vagrantup.com 注册个账户，把做好的box传上去。hashicorp对于公开的box，是没有限制的。如果要私有化自己的box，5$/m 私有项目数目不限制。</p><p>个人测试上传还好，但是从官网下载的话，还是找个国内速度快的地方搞吧。</p><h2 id=总结>总结</h2><p>制作本身并没有太难的地方，更多的还是遇到问题解决问题的过程并且总结更有意思一些。以后也多了一个在个人profiles页上的新资源：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Vagrant</span><span style=color:#f92672>.</span>configure(<span style=color:#e6db74>&#34;2&#34;</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>box <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;yimeng/alpine&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><h2 id=参考资料>参考资料</h2><ul><li><a href=https://www.vagrantup.com/docs/boxes/base.html>https://www.vagrantup.com/docs/boxes/base.html</a></li><li><a href=https://wiki.alpinelinux.org/wiki/Installation>https://wiki.alpinelinux.org/wiki/Installation</a></li><li><a href=https://wiki.alpinelinux.org/wiki/Alpine_Linux_package_management>https://wiki.alpinelinux.org/wiki/Alpine_Linux_package_management</a></li><li><a href=https://github.com/hashicorp/vagrant/tree/master/keys>https://github.com/hashicorp/vagrant/tree/master/keys</a></li></ul></article></html>